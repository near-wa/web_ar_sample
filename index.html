<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>web_ar_sample</title>
    <style>
        .disabled {
            display: none;
        }

        .btn {
            width: 300px;
            height: 150px;
            background: #eee;
            color: red;
        }
    </style>
</head>
<body>
<div id="button" class="btn"></div>
<div id="reticle"></div>

<script>
let xr = null
let xrHitTestSource = null
const reticleDom = document.getElementById('reticle')
const buttonDom = document.getElementById('button')
reticleDom.visible = false

const setDisabledAttribute = (disabled) => {
    if (disabled) {
      this.domElement.setAttribute('disabled', 'true');
    } else {
      this.domElement.removeAttribute('disabled');
    }
}

// 端末が対応しているかどうかの確認
if (navigator.xr) {
    xr = navigator.xr
    xr.isSessionSupported('immersive-ar')
        .then( (supported) => {
            // 対応している場合
            alert(supported)
            buttonDom.setDisabledAttribute(supported)
        })
}

// XRデバイスが対応している場合、XRセクションを要求
const onRequestSession = () => {
    alert('onRequestSession started')
    return xr.requestSession('immersive-ar', {
        requiredFeatures: ['local', 'hit-test']
    }).then((session) => {
        // xrセッションを開始する処理
        alert('session start')
        renderLoop(session)
    })
}

const renderLoop = (session) => {
    // 位置と向きを元の原点が追跡するトラッキング空間
    session.requestReferenceSpace('viewer').then((refSpace) => {
        xrViewerSpace = refSpace
        session.requestHitTestSource({ space: xrViewerSpace }).then( (hitTestSource) => {
            xrHitTestSource = hitTestSource
        })
    })

    session.requestReferenceSpace('local').then((refSpace) => {
        xrRefSpace = refSpace
        session.requestAnimationFrame(xrFrame) //Render loop処理のコール
    })
}

const xrFrame = (t, frame) => {
    if (xrHitTestSource && pose) {
        let hitTestResults = frame.getHitTestResults(xrHitTestSource);
        if (hitTestResults.length > 0) {
            //hit testを行い、hit testの結果が得られたら、バーチャルオブジェクト(reticle)を可視にセットする処理。表示位置はpose情報から取得
            let pose = hitTestResults[0].getPose(xrRefSpace);
            reticleDom.visible = true;
            reticleDom.matrix = pose.transform.matrix;
        }
    }
}
</script>
</body>
</html>